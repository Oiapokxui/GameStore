package usp.each.bd1.gamestore.web;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import usp.each.bd1.gamestore.data.entity.Custommer;
import usp.each.bd1.gamestore.data.entity.Person;
import usp.each.bd1.gamestore.data.repository.CustommerRepository;


@RestController
@RequestMapping("/client")
public class CustomerController {
    static class UpdateCustomerPayload {
        Custommer customer;
        Person person;

        public UpdateCustomerPayload(final Customer customer, final Person person) {
            this.customer = customer;
            this.person = person;
        }
    }

    @Autowired
    private CustomerRepository customerRepository;
    

    @GetMapping
    public Iterable<Customer> getCustommer() {
        return this.customerRepository.findAll();
    }

    @PostMapping("/delete")
    private void deleteCustomer(@RequestParam("cpf") String cpf) {
        this.customerRepository.deleteById(cpf);
    }


    @PostMapping("/edit")
    public void updateCustomer(@RequestBody UpdateCustomerPayload payload) {
        var updatedCustomer = payload.customer;
        var updatedPerson = payload.person;

        updatedCustomer.set(new Person(updatedCustomer.getCpf(), newCustomerName));
        var existingCustomer = this.customerRepository.findById(updatedCustomer.getCpf()).orElse(payload.customer);
        var existingPerson   = this.customerRepository.findById(updatedPerson.getCpf()).orElse(payload.customer);


        existingCustomer.getThisPerson().setCpf(updatedCustomer.getThisPerson().getCpf());
        existingPerson.getThisPerson().setName(updatedPerson.getThisPerson().getName());

        this.customerRepository.save(existingCustomer);
    }
}
